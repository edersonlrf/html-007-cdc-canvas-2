<!-- arquivo: jogo-definitivo.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, height=device-height, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <link rel="shortcut icon" type="image/png" href="img/nave.png"/>
    <title>Jogo de Nave - Controlado via Touch</title>
    <script src="cordova.js"></script>
    <script src="rAF.js"></script>
    <script src="animacao.js" type="text/javascript"></script>
    <script src="colisor.js" type="text/javascript"></script>
    <script src="fundo.js" type="text/javascript"></script>
    <script src="nave.js" type="text/javascript"></script>
    <script src="ovni.js" type="text/javascript"></script>
    <script src="tiro.js" type="text/javascript"></script>
    <script src="spritesheet.js" type="text/javascript"></script>
    <script src="explosao.js" type="text/javascript"></script>
    <script src="painel.js" type="text/javascript"></script>
    <style type="text/css">
    body {
        margin: 0;
        width: 100%;
        height: 100%;
    }
    #jogo_nave {
        width: 100%;
        height: auto;
    }
    #link_jogar {
        display: none;
        text-align: center;
        padding: 20px;
    }
    #link_jogar a {
        /* Inicia oculto. */
        display: inline-block;
        /* Cores e fundo. */
        color: yellow;
        background: url(img/botao-jogar.png);
        /* Fonte. */
        font-size: 20px;
        font-family: sans-serif;
        /* Sem sublinhado e com sombra. */
        text-decoration: none;
        text-shadow: 2px 2px 5px black;
        /* Posicionamento. */
        position: absolute;
        left: 220px;
        top: 330px;
        /* A imagem do botão é 72x72, descontamos os paddings. */
        width: 52px;
        height: 26px;
        padding: 23px 10px;
    }
    #postar_pontuacao {
        /* Ocultar o link. */
        display: none;
        /* Visual a gosto! */
        color: yellow;
        position: absolute;
        left: 180px;
        top: 410px;
    }
    </style>
</head>
<body>
    <script type="text/javascript">
    window.fbAsyncInit = function() {
        FB.init({
            appId            : '242642883161552',
            autoLogAppEvents : true,
            xfbml            : true,
            version          : 'v3.0'
        });
    };

    (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/pt_BR/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    </script>

    <canvas id="canvas_animacao" width="500" height="500"></canvas>

    <a id="link_jogar" href="javascript: iniciarJogo()">Jogar</a>

    <a id="postar_pontuacao" href="javascript: postarPontuacao()">
        Compartilhar Pontua&ccedil;&atilde;o
    </a>

    <br>

    <div id="botao_compartilhar" class="fb-share-button" data-href="https://html-004-cdc-canvas.herokuapp.com/" data-type="button_count"></div>

    <p>
        Setas: movimento <br>
        Espa&ccedil;o: tiro <br>
        Enter: pausa
    </p>

    <script type="text/javascript">
        // Canvas e context.
        var canvas = document.getElementById('canvas_animacao');
        var context = canvas.getContext('2d');

        // Variáveis principais.
        var imagens, animacao, colisor, nave, painel, criadorInimigos;
        var totalImagens = 0, carregadas = 0;
        var musicaAcao, somTiro, somExplosao;

        // Começa carregando as imagens e musicas.
        carregarImagens();
        carregarSons();

        function carregarImagens() {
            // Objeto contendo os nomes das imagens.
            imagens = {
                espaco: 'fundo-espaco.png',
                estrelas: 'fundo-estrelas.png',
                nuvens: 'fundo-nuvens.png',
                nave: 'nave-spritesheet.png',
                ovni: 'ovni.png',
                explosao: 'explosao.png'
            };

            // Carregar todas.
            for (var i in imagens) {
                var img = new Image();
                img.src = 'img/' + imagens[i];
                img.onload = carregando;
                totalImagens++;
                // Substituir o nome pela imagem.
                imagens[i] = img;
            }
        }

        function carregando() {
            context.save();

            // Fundo.
            context.drawImage(imagens.espaco, 0, 0, canvas.width, canvas.height);

            // Texto "Carregando"
            context.fillStyle = 'white';
            context.strokeStyle = 'black';
            context.font = '50px sans-serif';
            context.fillText("Carregando...", 100, 200);
            context.strokeText("Carregando...", 100, 200);

            // Barra de loading
            carregadas++;
            var tamanhoTotal = 300;
            var tamanho = carregadas / totalImagens * tamanhoTotal;
            context.fillStyle = 'yellow';
            context.fillRect(100, 250, tamanho, 50);

            context.restore();

            if (carregadas == totalImagens) {
                iniciarObjetos();
                mostrarLinkJogar();
            }
        }

        function iniciarObjetos() {
            // Objetos principais.
            animacao = new Animacao(context);
            // teclado = new Teclado(document);
            colisor = new Colisor();
            espaco = new Fundo(context, imagens.espaco);
            estrelas = new Fundo(context, imagens.estrelas);
            nuvens = new Fundo(context, imagens.nuvens);
            // nave = new Nave(context, teclado, imagens.nave, imagens.explosao);
            nave = new Nave(context, imagens.nave, imagens.explosao);
            painel = new Painel(context, nave);

            // Ligações entre objetos.
            animacao.novoSprite(espaco);
            animacao.novoSprite(estrelas);
            animacao.novoSprite(nuvens);
            animacao.novoSprite(painel);
            animacao.novoSprite(nave);
            colisor.novoSprite(nave);
            animacao.novoProcessamento(colisor);

            configuracoesIniciais();
        }

        function configuracoesIniciais() {
            // Fundos.
            espaco.velocidade = 60;
            estrelas.velocidade = 150;
            nuvens.velocidade = 500;

            // Nave
            nave.posicionar();
            nave.velocidade = 200;

            criacaoInimigos();

            // Pontuação
            colisor.aoColidir = function(o1, o2) {
                // Tiro com Ovni.
                if ( (o1 instanceof Tiro && o2 instanceof Ovni)
                    || (o1 instanceof Ovni && o2 instanceof Tiro) ) {
                    // Use o incremento que desejar.
                    painel.pontuacao += 10;
                    somExplosao.seekTo(0);
                    somExplosao.play();
                }

                // Nave com Ovni
                if ( (o1 instanceof Nave && o2 instanceof Ovni)
                    || (o1 instanceof Ovni && o2 instanceof Nave) ) {
                    somExplosao.seekTo(0);
                    somExplosao.play();
                }
            }

            // Game Over
            nave.acabaramVidas = function() {
                animacao.desligar();
                gameOver();
            }
        }

        function criacaoInimigos() {
            criadorInimigos = {
                ultimoOvni: new Date().getTime(),
                processar: function() {
                    var agora = new Date().getTime();
                    var decorrido = agora - this.ultimoOvni;
                    if (decorrido > 1000) {
                        novoOvni();
                        this.ultimoOvni = agora;
                    }
                }
            };

            animacao.novoProcessamento(criadorInimigos);
        }

        function novoOvni() {
            var imgOvni = imagens.ovni;
            var ovni = new Ovni(context, imgOvni, imagens.explosao);

            // Mínimo: 500; máximo: 1000
            ovni.velocidade = Math.floor( 500 + Math.random() * (1000 - 500 + 1) );

            // Mínimo: 0; máximo: largura do canvas - largura do ovni
            ovni.x = Math.floor(Math.random() * (canvas.width - imgOvni.width + 1));

            // Descontar a altura.
            ovni.y = -imgOvni.height;

            animacao.novoSprite(ovni);

            colisor.novoSprite(ovni);
        }

        function pausarJogo() {
            if (animacao.ligado) {
                animacao.desligar();
                ativarTiro(false);

                // Escrever "Pausado".
                context.save();
                context.fillStyle = 'white';
                context.strokeStyle = 'black';
                context.font = '50px sans-serif';
                context.fillText("Pausado", 160, 200);
                context.strokeText("Pausado", 160, 200);
                context.restore();
            } else {
                criadorInimigos.ultimoOvni = new Date().getTime();
                animacao.ligar();
                ativarTiro(true);
            }
        }

        function ativarTiro(ativar) {
            // if (ativar) {
            //     teclado.disparou(ESPACO, function() {
            //         nave.atirar();
            //     });
            // } else {
            //     teclado.disparou(ESPACO, null);
            // }
        }

        function carregarSons() {
            musicaAcao = new Media('file:///android_asset/musica-acao.mp3');
            somTiro = new Media('file:///android_asset/tiro.mp3');
            somExplosao = new Media('file:///android_asset/explosao.mp3');
        }

        function mostrarLinkJogar() {
            document.getElementById('link_jogar').style.display = 'block';
        }

        function iniciarJogo() {
            criadorInimigos.ultimoOvni = new Date().getTime();

            // Tiro.
            ativarTiro(true);

            // Pausa.
            // teclado.disparou(ENTER, pausarJogo);

            document.getElementById('link_jogar').style.display = 'none';
            document.getElementById('postar_pontuacao').style.display = 'none';

            painel.pontuacao = 0;
            // musicaAcao.play();
            animacao.ligar();

            musicaAcao.seekTo(0);
            musicaAcao.play();
        }

        function gameOver() {
            musicaAcao.pause();

            // Tiro.
            ativarTiro(false);

            // Pausa.
            // teclado.disparou(ENTER, null);

            // Parar a música e rebobinar.
            // musicaAcao.pause();
            // musicaAcao.currentTime = 0.0;

            // Fundo.
            context.drawImage(imagens.espaco, 0, 0, canvas.width, canvas.height);

            // Texto "Game Over".
            context.save();
            context.fillStyle = 'white';
            context.strokeStyle = 'black';
            context.font = '70px sans-serif';
            context.fillText("GAME OVER", 40, 200);
            context.strokeText("GAME OVER", 40, 200);
            context.restore();

            // Volta o link "Jogar".
            mostrarLinkJogar();

            // Restaurar as condições da nave.
            nave.vidasExtras = 3;

            nave.posicionar();

            animacao.novoSprite(nave);

            colisor.novoSprite(nave);

            // Tirar todos os inimigos da tela.
            removerInimigos();

            // Link de postar pontuação.
            document.getElementById('postar_pontuacao').style.display = 'block';
        }

        function removerInimigos() {
            for (var i in animacao.sprites) {
                if (animacao.sprites[i] instanceof Ovni) {
                    animacao.excluirSprite(animacao.sprites[i]);
                }
            }
        }

        function postarPontuacao() {
            // API de feed do Facebook.
            FB.ui({
                method: 'feed',
                name: 'Jogo de Nave',
                caption: 'Jogue e compartilhe com seus amigos!',
                description: (
                    'Minha pontuação foi: ' + painel.pontuacao
                ),
                link: 'https://html-004-cdc-canvas.herokuapp.com/'
            },
            function(response) {

            });
        }
    </script>
</body>
</html>
